
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Primary One Registration Statistics Visualiser</title>
    <meta name="description" content="Visualisation of Singapore Primary Schools and associated registration statistics"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <link rel="stylesheet" href="./css/extra.css" />
    <script src="./leaflet/leaflet.js"></script>
    <script src="geodata.geojson" type="text/javascript"></script>
  </head>
	<body>
		<section class="page-header">
			<h1 class="project-name">PriOneRegViz</h1>
			<h2 class="project-tagline">Visualisation of Singapore Primary Schools and associated registration statistics</h2>
			<a href="https://github.com/origamiwolf/PriOneRegViz" class="btn">View on GitHub</a>
		</section>

    <section class="main-content">
      <h2 id="primary-one-registration-statistics-visualiser">Primary One Registration Statistics Visualiser</h2>

<p>A Leaflet.js map showing Singapore’s primary schools, and statistics pertaining to the Primary One Registration Exercise.</p>
<div id="mapbox">
<div id="mapnav">Mouseover each marker to bring up statistics for the school.<br><br>Click on a map point to list schools within a 2 km radius, or enter a postal code below: 
<input type="text" id="searchVal"><input type="button" onclick="UserAction()">
<p></p><div id="sch_list"></div></div>
<div id="map"></div>
</div>
<script>
function UserAction() {
	searchVal = document.getElementById("searchVal").value;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", "https://developers.onemap.sg/commonapi/search?searchVal=" + searchVal + "&returnGeom=Y&getAddrDetails=Y&pageNum=1", true);
//    xhttp.setRequestHeader("Content-type", "application/json");
    xhr.send();
//    var response = JSON.parse(xhttp.responseText);
    console.log(xhr.status);
    console.log(xhr.statusText);
}	
	
	
	var map = L.map('map').setView([1.3603, 103.8084], 12);

	var basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Default/{z}/{x}/{y}.png', {
			attribution: 'Map data &copy; contributors, <a href="http://SLA.gov.sg">Singapore Land Authority</a>',
			maxZoom: 18,
            		minZoom: 11
			});

	attribution = map.attributionControl;
	attribution.setPrefix('<img src="https://docs.onemap.sg/maps/images/oneMap64-01.png" style="height:20px;width:20px;"/>');

	map.setMaxBounds([[1.7, 106.0], [1.0, 102.0]]);
	basemap.addTo(map);

	/* add schools	*/
	var schoolCoords = []
	L.geoJSON(schools, {
		onEachFeature: schoolPopup
	}).addTo(map);

	/* display school information in popup */
	function schoolPopup(feature, layer) {
		var mtM = feature.properties.MT.includes('M') ? 'Malay':'';
		var mtC = feature.properties.MT.includes('C') ? 'Chinese':'';
		var mtT = feature.properties.MT.includes('T') ? 'Tamil':'';
		var Y2016 = feature.properties.Y2016.split(',');
		var Y2015 = feature.properties.Y2015.split(',');
		var Y2014 = feature.properties.Y2014.split(',');
		var p_name = ['Phase 1','Phase 2A1','Phase2A2','','','Phase 2B','','Phase 2C','','Phase 2C(S)'];
		// stuff coordinates into an array for distance calculations later.  Reversed coordinates again cos of GeoJSON
		schoolCoords.push([feature.geometry.coordinates[1], feature.geometry.coordinates[0]]);

		function displayPlace(x) {
			var ret = '<td class="td1">';
			if (x == 0) {
				ret = ret + '-';
			} else {
				ret = ret + '<b>' + x + '</b></td>';
			} 
			return ret;
		}
		
		function displayOcc(x) {
			var ret = '<td class="td1">';
			if (x == 0) {
				ret = ret + '-';
			} else ret = ret + ((x >= 100) ? '<b>' + x + '%</b></td>' : x + '%</td>');
			return ret;
		}

		function displayOccApp(x, y) {
			var ret = '<td class="td1">';
			if (x == 0 && y <= 0.01) {
				ret = ret + '-</td>'; 
			} else {
				ret = ret + '<div style="width:50%; float:left">';
				if (x == 0) {
					ret = ret + '-';
				} else ret = ret + ((x >=100) ? '<b>' + x + '%</b>': x + '%'); 
	
				ret = ret + '</div><div style="width:50%; float:right">';	
						
				if (y > 1.00) {
					ret = ret + '<b>(' + y + ')</b>';
				} else ret = ret + ((y <= 0.01) ? '( - )' : '(' + y + ')');
				ret = ret + '</div></td>';
			}
			return ret;
		}
						
		var sch_data = '<h2>'+feature.properties.School+'</h2>';
		sch_data = sch_data + '<b>Handicap Facilities</b>: ' + feature.properties.HFac + '<br>';
		sch_data = sch_data + '<b>Mother Tongues Offered: </b>' + mtM + ' ' + mtC + ' ' + mtT + '<br><br>';
		sch_data = sch_data + '<table>';
		sch_data = sch_data + '<tr><th></th><th>2016</th><th>2015</th><th>2014</th></tr>';		
		sch_data = sch_data + '<tr><td class="td0">Places</td>' + displayPlace(Y2016[0]) + displayPlace(Y2015[0]) + displayPlace(Y2014[0]) + '</tr>';
		
		for (i=1;i<4;i++) {
			sch_data = sch_data + '<tr><td class="td0">' + p_name[i-1] + '</td>' + displayOcc(Y2016[i]) + displayOcc(Y2015[i]) + displayOcc(Y2014[i]) + '</tr>';
		}
		
		for (i=5;i<10;i+=2) {
			sch_data = sch_data + '<tr><td class="td0">' + p_name[i] + '</td>' + displayOccApp(Y2016[i], Y2016[i-1]) + displayOccApp(Y2015[i], Y2015[i-1]) + displayOccApp(Y2014[i], Y2014[i-1]);
		}
		
		sch_data = sch_data + '</table>';

		layer.bindPopup(sch_data, {maxWidth: '400', className: 'custom-popup'});

		/* marker functionality */
		/* enable marker highlights */
		var mapIcon = L.Icon.Default.extend({
		});
		var regIcon = new mapIcon({ iconUrl: "marker-icon.png" });
		var highIcon = new mapIcon({ iconUrl: "marker-icon2.png" });

		/* activate and highlight on mouseover */
		layer.on('mouseover', function(e) { layer.openPopup(); e.target.setIcon(highIcon); });
		layer.on('mouseout', function(e) { e.target.setIcon(regIcon); layer.closePopup(); });
	}

	/* add functionality for the 1 km and 2 km circles */
	/* I really should be defining a new layer group for this */
	var clickCircle1;
	var clickCircle2;
	var clickCircleCentre;
	
	function onMapClick(e) {
		if (clickCircleCentre != undefined) {
			map.removeLayer(clickCircle1);
			map.removeLayer(clickCircle2);
			map.removeLayer(clickCircleCentre);
		}

		/* iterate through the list of schools to check if they are within the circles*/
		
		nearbySchools = [];
		for (i=0;i<schoolCoords.length;i++) {
			dist = e.latlng.distanceTo(schoolCoords[i]);
			if (dist<=2000) {
				nearbySchools.push({ sch_index: i, sch_dist: dist });
			}
		}
		nearbySchools = nearbySchools.sort(function(a,b) { return a.sch_dist - b.sch_dist});
		
		var sch_list = document.getElementById("sch_list");
			while(sch_list.firstChild) {
				sch_list.removeChild(sch_list.firstChild);
			}
		for (i=0;i<nearbySchools.length;i++) {
			var sch_text = document.createElement("p");
			var sch_name = sch_text.appendChild(document.createElement("b"));
			sch_name.appendChild(document.createTextNode(schools.features[nearbySchools[i].sch_index].properties.School));
			sch_text.appendChild(document.createElement("br"));
			sch_text.appendChild(document.createTextNode((nearbySchools[i].sch_dist/1000).toFixed(1)));			
			
			document.getElementById("sch_list").appendChild(sch_text);
		}
		
		clickCircle1 = L.circle(e.latlng, 2000, {
			color: '#f07300',
			opacity: 0.3
		}).addTo(map);
		
		clickCircle2 = L.circle(e.latlng, 1000, {
			color: '#f07300',
			opacity: 0.5
		}).addTo(map);		
		
		clickCircleCentre = L.circle(e.latlng, 2, {
			color: '#000000',
			opacity: 0.75
		}).addTo(map);
	}
	
	map.on('click', onMapClick);

</script>
<h3>Implementation Notes</h3>
Schools Geodata obtained from <a href="https://data.gov.sg">Data.gov.sg</a> and <a href="[https://www.onemap.sg]">OneMap</a>. Schools registration statistics taken from various online sources (<a href="https://www.kiasuparents.com">KiasuParents</a>, <a href="http://www.domainofexperts.com">Domain Of Experts</a>, <a href="https://elite.com.sg">elite.com.sg</a> and individual school websites).
Data was cleaned and coded into GeoJSON in Python.
</p>

<h3>Disclaimer</h3>
<p>This visualisation was done as a programming exercise.  If you actually make use of it to plan your Primary One registration strategy for your kid, don’t hold me responsible if your kid doesn’t get into your school of choice.  Registration statistics are provided as-is, and no claims are made as to the accuracy of the data.</p>

      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/origamiwolf/PriOneRegViz">PriOneRegViz</a> is maintained by <a href="https://github.com/origamiwolf">origamiwolf</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </section>

    
  </body>
</html>

